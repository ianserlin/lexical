/**
 * Copyright (c) Meta Platforms, Inc. and affiliates.
 *
 * This source code is licensed under the MIT license found in the
 * LICENSE file in the root directory of this source tree.
 */
import{$generateHtmlFromNodes as e}from"@lexical/html";import{$isLinkNode as t}from"@lexical/link";import{$isMarkNode as n}from"@lexical/mark";import{$isTableSelection as o}from"@lexical/table";import{mergeRegister as r}from"@lexical/utils";import{COMMAND_PRIORITY_HIGH as l,$getSelection as i,$getRoot as a,$isRangeSelection as s,$isElementNode as c,$isNodeSelection as u,$isTextNode as f}from"lexical";import*as d from"react";import{useState as m,useRef as g,useMemo as p,useCallback as h,useEffect as y}from"react";const b=Object.freeze({"\t":"\\t","\n":"\\n"}),E=new RegExp(Object.keys(b).join("|"),"g"),C=Object.freeze({ancestorHasNextSibling:"|",ancestorIsLastChild:" ",hasNextSibling:"├",isLastChild:"└",selectedChar:"^",selectedLine:">"});function $({treeTypeButtonClassName:e,timeTravelButtonClassName:t,timeTravelPanelSliderClassName:n,timeTravelPanelButtonClassName:o,viewClassName:i,timeTravelPanelClassName:a,editor:s}){const[c,u]=m([]),[f,b]=m(""),[E,C]=m(!1),[$,S]=m(!1),x=g(0),T=g(null),j=g(null),[k,L]=m(!1),[v,B]=m(!1),[w,_]=m(!1),D=g(null),F=function(e){const[t,n]=m([]);return y((()=>{const t=new Set;for(const[o]of e._commands)t.add(e.registerCommand(o,(e=>(n((t=>{const n=[...t];return n.push({payload:e,type:o.type?o.type:"UNKNOWN"}),n.length>10&&n.shift(),n})),!1)),l));return()=>t.forEach((e=>e()))}),[e]),p((()=>t),[t])}(s),K=h((e=>{const t=N(s,F,$);b(t),E||u((t=>[...t,[Date.now(),e]]))}),[F,s,E,$]);y((()=>{const e=s.getEditorState();!w&&e._nodeMap.size<1e3&&b(N(s,F,$))}),[F,s,w,$]),y((()=>r(s.registerUpdateListener((({editorState:e})=>{!w&&e._nodeMap.size>1e3&&(D.current=e,B(!0),!w)||K(e)})),s.registerEditableListener((()=>{const e=N(s,F,$);b(e)})))),[F,s,$,v,K,w]);const R=c.length;return y((()=>{if(k){let e;const t=()=>{const n=x.current;if(n===R-1)return void L(!1);const o=c[n][0],r=c[n+1][0];e=setTimeout((()=>{x.current++;const e=x.current,n=j.current;null!==n&&(n.value=String(e)),s.setEditorState(c[e][1]),t()}),r-o)};return t(),()=>{clearTimeout(e)}}}),[c,k,s,R]),y((()=>{const e=T.current;if(null!==e)return e.__lexicalEditor=s,()=>{e.__lexicalEditor=null}}),[s]),d.createElement("div",{className:i},!w&&v?d.createElement("div",{style:{padding:20}},d.createElement("span",{style:{marginRight:20}},"Detected large EditorState, this can impact debugging performance."),d.createElement("button",{onClick:()=>{_(!0);const e=D.current;null!==e&&(D.current=null,K(e))},style:{background:"transparent",border:"1px solid white",color:"white",cursor:"pointer",padding:5}},"Show full tree")):null,w?null:d.createElement("button",{onClick:()=>S(!$),className:e,type:"button"},$?"Tree":"Export DOM"),!E&&(w||!v)&&R>2&&d.createElement("button",{onClick:()=>{const e=s.getRootElement();null!==e&&(e.contentEditable="false",x.current=R-1,C(!0))},className:t,type:"button"},"Time Travel"),(w||!v)&&d.createElement("pre",{ref:T},f),E&&(w||!v)&&d.createElement("div",{className:a},d.createElement("button",{className:o,onClick:()=>{x.current===R-1&&(x.current=1),L(!k)},type:"button"},k?"Pause":"Play"),d.createElement("input",{className:n,ref:j,onChange:e=>{const t=Number(e.target.value),n=c[t];n&&(x.current=t,s.setEditorState(n[1]))},type:"range",min:"1",max:R-1}),d.createElement("button",{className:o,onClick:()=>{const e=s.getRootElement();if(null!==e){e.contentEditable="true";const t=c.length-1,n=c[t];s.setEditorState(n[1]);const o=j.current;null!==o&&(o.value=String(t)),C(!1),L(!1)}},type:"button"},"Exit")))}function N(r,l,d){const m=r.getEditorState(),g=r._config,p=r._compositionKey,h=r._editable;if(d){let t="";return m.read((()=>{t=function(e){const t=document.createElement("div");return t.innerHTML=e.trim(),F(t,0).innerHTML}(e(r))})),t}let y=" root\n";const b=m.read((()=>{const e=i();return S(a(),((o,r)=>{const l=`(${o.getKey()})`,i=o.getType()||"",a=o.isSelected(),d=n(o)?` id: [ ${o.getIDs().join(", ")} ] `:"";y+=`${a?C.selectedLine:" "} ${r.join(" ")} ${l} ${i} ${d} ${function(e){if(f(e)){const t=e.getTextContent(),n=0===t.length?"(empty)":`"${x(t)}"`,o=function(e){return[B(e),L(e),v(e)].filter(Boolean).join(", ")}(e);return[n,0!==o.length?`{ ${o} }`:null].filter(Boolean).join(" ").trim()}if(t(e)){const t=e.getURL(),n=0===t.length?"(empty)":`"${x(t)}"`,o=function(e){return[w(e),_(e),D(e)].filter(Boolean).join(", ")}(e);return[n,0!==o.length?`{ ${o} }`:null].filter(Boolean).join(" ").trim()}return""}(o)}\n`,y+=function({indent:e,isSelected:t,node:n,nodeKeyDisplay:o,selection:r,typeDisplay:l}){if(!f(n)||!s(r)||!t||c(n))return"";const i=r.anchor,a=r.focus;if(""===n.getTextContent()||i.getNode()===r.focus.getNode()&&i.offset===a.offset)return"";const[d,m]=function(e,t){const n=t.getStartEndPoints();if(u(t)||null===n)return[-1,-1];const[o,r]=n,l=e.getTextContent(),i=l.length;let a=-1,s=-1;if("text"===o.type&&"text"===r.type){const t=o.getNode(),n=r.getNode();t===n&&e===t&&o.offset!==r.offset?[a,s]=o.offset<r.offset?[o.offset,r.offset]:[r.offset,o.offset]:[a,s]=e===t?t.isBefore(n)?[o.offset,i]:[0,o.offset]:e===n?n.isBefore(t)?[r.offset,i]:[0,r.offset]:[0,i]}const c=(l.slice(0,a).match(E)||[]).length,f=(l.slice(a,s).match(E)||[]).length;return[a+c,s+c+f]}(n,r);if(d===m)return"";const g=e[e.length-1]===C.hasNextSibling?C.ancestorHasNextSibling:C.ancestorIsLastChild,p=[...e.slice(0,e.length-1),g],h=Array(d+1).fill(" "),y=Array(m-d).fill(C.selectedChar),b=l.length+3,$=Array(o.length+b).fill(" ");return[C.selectedLine,p.join(" "),[...$,...h,...y].join("")].join(" ")+"\n"}({indent:r,isSelected:a,node:o,nodeKeyDisplay:l,selection:e,typeDisplay:i})})),null===e?": null":s(e)?function(e){let t="";const n=B(e);t+=`: range ${""!==n?`{ ${n} }`:""} ${""!==e.style?`{ style: ${e.style} } `:""}`;const o=e.anchor,r=e.focus,l=o.offset,i=r.offset;return t+=`\n  ├ anchor { key: ${o.key}, offset: ${null===l?"null":l}, type: ${o.type} }`,t+=`\n  └ focus { key: ${r.key}, offset: ${null===i?"null":i}, type: ${r.type} }`,t}(e):o(e)?function(e){return`: table\n  └ { table: ${e.tableKey}, anchorCell: ${e.anchor.key}, focusCell: ${e.focus.key} }`}(e):function(e){return u(e)?`: node\n  └ [${Array.from(e._nodes).join(", ")}]`:""}(e)}));if(y+="\n selection"+b,y+="\n\n commands:",l.length)for(const{type:e,payload:t}of l)y+=`\n  └ { type: ${e}, payload: ${t instanceof Event?t.constructor.name:t} }`;else y+="\n  └ None dispatched.";return y+="\n\n editor:",y+=`\n  └ namespace ${g.namespace}`,null!==p&&(y+=`\n  └ compositionKey ${p}`),y+=`\n  └ editable ${String(h)}`,y}function S(e,t,n=[]){const o=e.getChildren(),r=o.length;o.forEach(((e,o)=>{t(e,n.concat(o===r-1?C.isLastChild:C.hasNextSibling)),c(e)&&S(e,t,n.concat(o===r-1?C.ancestorIsLastChild:C.ancestorHasNextSibling))}))}function x(e){return Object.entries(b).reduce(((e,[t,n])=>e.replace(new RegExp(t,"g"),String(n))),e)}const T=[e=>e.hasFormat("bold")&&"Bold",e=>e.hasFormat("code")&&"Code",e=>e.hasFormat("italic")&&"Italic",e=>e.hasFormat("strikethrough")&&"Strikethrough",e=>e.hasFormat("subscript")&&"Subscript",e=>e.hasFormat("superscript")&&"Superscript",e=>e.hasFormat("underline")&&"Underline"],j=[e=>e.isDirectionless()&&"Directionless",e=>e.isUnmergeable()&&"Unmergeable"],k=[e=>e.isToken()&&"Token",e=>e.isSegmented()&&"Segmented"];function L(e){let t=j.map((t=>t(e))).filter(Boolean).join(", ").toLocaleLowerCase();return""!==t&&(t="detail: "+t),t}function v(e){let t=k.map((t=>t(e))).filter(Boolean).join(", ").toLocaleLowerCase();return""!==t&&(t="mode: "+t),t}function B(e){let t=T.map((t=>t(e))).filter(Boolean).join(", ").toLocaleLowerCase();return""!==t&&(t="format: "+t),t}function w(e){let t=e.getTarget();return null!=t&&(t="target: "+t),t}function _(e){let t=e.getRel();return null!=t&&(t="rel: "+t),t}function D(e){let t=e.getTitle();return null!=t&&(t="title: "+t),t}function F(e,t){const n=new Array(1+t++).join("  "),o=new Array(t-1).join("  ");let r;for(let l=0;l<e.children.length;l++)r=document.createTextNode("\n"+n),e.insertBefore(r,e.children[l]),F(e.children[l],t),e.lastElementChild===e.children[l]&&(r=document.createTextNode("\n"+o),e.appendChild(r));return e}export{$ as TreeView};
